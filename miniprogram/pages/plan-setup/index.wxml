<view class="page">
  <view class="header">
    <view class="title">计划设置</view>
    <view class="subtitle">填写基础信息，生成计划并排期。</view>
  </view>

  <view class="card">
    <view class="section-title">训练基础信息</view>
    <view class="field">
      <view class="label">当前能力水平</view>
      <input
        class="input"
        placeholder="例如：初级/中级/高级"
        data-field="abilityLevel"
        bindinput="onInputChange"
        value="{{profile.abilityLevel}}"
      />
    </view>
    <view class="field">
      <view class="label">训练频率</view>
      <input
        class="input"
        placeholder="例如：每周 3 次"
        data-field="trainingFrequency"
        bindinput="onInputChange"
        value="{{profile.trainingFrequency}}"
      />
    </view>
    <view class="field">
      <view class="label">可用训练时长</view>
      <input
        class="input"
        placeholder="例如：30 分钟"
        data-field="sessionDuration"
        bindinput="onInputChange"
        value="{{profile.sessionDuration}}"
      />
    </view>
    <view class="field">
      <view class="label">伤病/限制（可选）</view>
      <input
        class="input"
        placeholder="如肩部不适"
        data-field="injuryNotes"
        bindinput="onInputChange"
        value="{{profile.injuryNotes}}"
      />
    </view>
  </view>

  <view class="card">
    <view class="section-title">计划信息</view>
    <view class="field">
      <view class="label">计划名称</view>
      <input
        class="input"
        placeholder="例如：我的进阶计划"
        data-field="planName"
        bindinput="onPlanInputChange"
        value="{{planName}}"
      />
    </view>
    <view class="field">
      <view class="label">计划类型</view>
      <view class="pills">
        <view class="pill {{planType === '自建' ? 'pill-active' : ''}}" data-type="自建" bindtap="onSelectPlanType">自建</view>
        <view class="pill {{planType === '推荐' ? 'pill-active' : ''}}" data-type="推荐" bindtap="onSelectPlanType">推荐</view>
      </view>
    </view>
    <view class="hint">推荐计划将按第十二章规则生成。</view>
  </view>

  <view class="card">
    <view class="section-title">起始等级</view>
    <view class="exercise" wx:for="{{exercises}}" wx:key="id">
      <view class="exercise-name">{{item.name}}</view>
      <picker
        mode="selector"
        range="{{levelOptions}}"
        value="{{levelOptions.indexOf(startLevels[item.id])}}"
        data-id="{{item.id}}"
        bindchange="onSelectLevel"
      >
        <view class="picker">第 {{startLevels[item.id]}} 级</view>
      </picker>
    </view>
  </view>

  <view class="card">
    <view class="section-title">排期视图</view>
    <view class="tabs">
      <view class="tab {{scheduleType === 'week' ? 'tab-active' : ''}}" data-type="week" bindtap="onSelectScheduleType">周</view>
      <view class="tab {{scheduleType === 'month' ? 'tab-active' : ''}}" data-type="month" bindtap="onSelectScheduleType">月</view>
      <view class="tab {{scheduleType === 'calendar' ? 'tab-active' : ''}}" data-type="calendar" bindtap="onSelectScheduleType">日历</view>
    </view>

    <view wx:if="{{scheduleType === 'week'}}" class="schedule-panel">
      <view class="schedule-title">本周训练日</view>
      <view class="week-grid">
        <view
          class="week-day {{item.selected ? 'selected' : ''}}"
          wx:for="{{weekDays}}"
          wx:key="date"
          data-date="{{item.date}}"
          bindtap="onToggleWeekDay"
        >
          <view class="week-label">{{item.label}}</view>
          <view class="week-date">{{item.dateLabel}}</view>
        </view>
      </view>
    </view>

    <view wx:if="{{scheduleType === 'month'}}" class="schedule-panel">
      <view class="schedule-title">本月训练日</view>
      <view class="calendar-grid">
        <view
          class="calendar-cell {{item.empty ? 'empty' : ''}} {{item.selected ? 'selected' : ''}}"
          wx:for="{{monthGrid}}"
          wx:key="key"
          data-date="{{item.date}}"
          bindtap="onToggleMonthDay"
        >
          <view class="calendar-text">{{item.label}}</view>
        </view>
      </view>
    </view>

    <view wx:if="{{scheduleType === 'calendar'}}" class="schedule-panel">
      <view class="schedule-title">日历排期</view>
      <view class="calendar-grid">
        <view
          class="calendar-cell {{item.empty ? 'empty' : ''}} {{item.selected ? 'selected' : ''}}"
          wx:for="{{calendarGrid}}"
          wx:key="key"
          data-date="{{item.date}}"
          bindtap="onToggleCalendarDay"
        >
          <view class="calendar-text">{{item.label}}</view>
        </view>
      </view>
    </view>
  </view>

  <view class="card" wx:if="{{recommendation}}">
    <view class="section-title">推荐计划预览</view>
    <view class="recommendation-row">计划：{{recommendation.planName || '-'}}</view>
    <view class="recommendation-row">频率：{{recommendation.weeklySessions || '-'}} 次 / 周</view>
    <view class="recommendation-row">组数范围：{{recommendation.setsRange || '-'}}</view>
  </view>

  <view class="card">
    <view class="section-title">动作练习方法</view>
    <view class="field">
      <view class="label">动作</view>
      <picker mode="selector" range="{{exerciseOptions}}" value="{{methodExerciseIndex}}" bindchange="onMethodExerciseChange">
        <view class="picker">{{exerciseOptions[methodExerciseIndex]}}</view>
      </picker>
    </view>
    <view class="field">
      <view class="label">级别</view>
      <picker mode="selector" range="{{levelOptions}}" value="{{levelOptions.indexOf(methodLevel)}}" bindchange="onMethodLevelChange">
        <view class="picker">第 {{methodLevel}} 级</view>
      </picker>
    </view>
    <view class="method-block" wx:if="{{methodDetail}}">
      <view class="method-title">{{methodDetail.levelName}}</view>
      <view class="method-text">{{methodDetail.method}}</view>
      <view class="method-targets">升级标准：{{methodDetail.targets.upgrade || "-"}}</view>
    </view>
    <view class="method-empty" wx:else>
      暂无该动作的训练方法，请稍后刷新。
    </view>
  </view>

  <view class="actions">
    <button class="secondary-button" loading="{{submitting}}" bindtap="onGenerateRecommendation">
      生成推荐计划
    </button>
    <button class="primary-button" loading="{{submitting}}" bindtap="onCreatePlan">
      创建计划并保存排期
    </button>
  </view>
</view>
