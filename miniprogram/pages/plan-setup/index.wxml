<view class="page">
  <view class="header">
    <view class="title">计划设置</view>
    <view class="subtitle">先定等级与排期，一键保存云端</view>
  </view>

  <view class="hero-card">
    <view class="hero-top">
      <view class="hero-badge">{{currentStageName}}</view>
      <view class="hero-stage">六艺等级排期</view>
    </view>
    <view class="hero-title">先定等级，再定排期</view>
    <view class="hero-subtitle">周/月/日历统一配置，创建后立即生效。</view>
  </view>

  <view class="card">
    <view class="section-title">训练基础信息</view>
    <view class="field">
      <view class="label">当前能力水平</view>
      <picker
        mode="selector"
        range="{{abilityLevelOptions}}"
        value="{{abilityLevelIndex}}"
        bindchange="onAbilityLevelChange"
      >
        <view class="picker">{{abilityLevelOptions[abilityLevelIndex]}}</view>
      </picker>
    </view>
  </view>

  <view class="card">
    <view class="section-title">计划信息</view>
    <view class="field">
      <view class="label">计划名称</view>
      <input
        class="input"
        placeholder="例如：我的进阶计划"
        data-field="planName"
        bindinput="onPlanInputChange"
        value="{{planName}}"
      />
    </view>
  </view>

  <view class="card">
    <view class="section-title">起始等级</view>
    <view class="exercise" wx:for="{{exercises}}" wx:key="id">
      <view class="exercise-name {{lockedExerciseIds.includes(item.id) ? 'locked' : ''}}">
        {{item.name}}
        <text wx:if="{{lockedExerciseIds.includes(item.id)}}" class="lock-tag">（未解锁）</text>
      </view>
      <picker
        disabled="{{lockedExerciseIds.includes(item.id)}}"
        mode="selector"
        range="{{levelOptions}}"
        value="{{levelOptions.indexOf(startLevels[item.id])}}"
        data-id="{{item.id}}"
        bindchange="onSelectLevel"
      >
        <view class="picker">第{{startLevels[item.id]}}式</view>
      </picker>
      <view class="level-name" wx:if="{{levelNameMap[item.id]}}">
        {{levelNameMap[item.id]}}
      </view>
    </view>
  </view>

  <view class="card">
    <view class="section-title">排期视图</view>
    <view class="tabs">
      <view class="tab {{scheduleType === 'week' ? 'tab-active' : ''}}" data-type="week" bindtap="onSelectScheduleType">周</view>
      <view class="tab {{scheduleType === 'month' ? 'tab-active' : ''}}" data-type="month" bindtap="onSelectScheduleType">月</view>
      <view class="tab {{scheduleType === 'calendar' ? 'tab-active' : ''}}" data-type="calendar" bindtap="onSelectScheduleType">日历</view>
    </view>

    <view wx:if="{{scheduleType === 'week'}}" class="schedule-panel">
      <view class="schedule-title">每周训练安排</view>
      <view class="week-exercise" wx:for="{{weekScheduleRows}}" wx:key="id">
        <view class="week-exercise-name {{item.locked ? 'locked' : ''}}">
          {{item.name}}
        </view>
        <view class="week-chip-row">
          <view
            class="week-chip {{day.selected ? 'selected' : ''}} {{item.locked ? 'disabled' : ''}}"
            wx:for="{{item.days}}"
            wx:for-item="day"
            wx:key="day"
            data-exercise-id="{{item.id}}"
            data-day="{{day.day}}"
            bindtap="onToggleWeekExerciseDay"
          >
            {{day.label}}
          </view>
        </view>
      </view>
      <view class="hint">周排期会自动在每周重复。</view>
    </view>

    <view wx:if="{{scheduleType === 'month'}}" class="schedule-panel">
      <view class="schedule-title">每月训练安排</view>
      <view class="field" wx:if="{{scheduleExerciseOptions.length}}">
        <view class="label">动作</view>
        <picker
          mode="selector"
          range="{{scheduleExerciseOptions}}"
          value="{{scheduleExerciseIndex}}"
          bindchange="onSelectScheduleExercise"
        >
          <view class="picker">{{scheduleExerciseOptions[scheduleExerciseIndex]}}</view>
        </picker>
      </view>
      <view class="method-empty" wx:else>
        当前阶段无可安排动作。
      </view>
      <view class="calendar-grid">
        <view
          class="calendar-cell {{item.empty ? 'empty' : ''}} {{item.selected ? 'selected' : ''}}"
          wx:for="{{monthGrid}}"
          wx:key="key"
          data-date="{{item.date}}"
          bindtap="onToggleMonthDay"
        >
          <view class="calendar-text">{{item.label}}</view>
        </view>
      </view>
      <view class="hint">月排期会自动在每月重复。</view>
    </view>

    <view wx:if="{{scheduleType === 'calendar'}}" class="schedule-panel">
      <view class="schedule-title">日历排期</view>
      <view class="calendar-grid">
        <view
          class="calendar-cell {{item.empty ? 'empty' : ''}} {{item.selected ? 'selected' : ''}}"
          wx:for="{{calendarGrid}}"
          wx:key="key"
          data-date="{{item.date}}"
          bindtap="onToggleCalendarDay"
        >
          <view class="calendar-text">{{item.label}}</view>
        </view>
      </view>
    </view>
  </view>

  <view class="schedule-actions">
    <button class="primary-button" loading="{{submitting}}" bindtap="onCreatePlan">
      创建计划并保存排期
    </button>
  </view>

  <view class="card">
    <view class="section-title">动作练习方法</view>
    <view class="field">
      <view class="label">动作</view>
      <picker mode="selector" range="{{exerciseOptions}}" value="{{methodExerciseIndex}}" bindchange="onMethodExerciseChange">
        <view class="picker">{{exerciseOptions[methodExerciseIndex]}}</view>
      </picker>
    </view>
    <view class="field">
      <view class="label">级别</view>
      <picker mode="selector" range="{{levelOptions}}" value="{{levelOptions.indexOf(methodLevel)}}" bindchange="onMethodLevelChange">
        <view class="picker">第{{methodLevel}}式</view>
      </picker>
    </view>
    <view class="method-block" wx:if="{{methodDetail}}">
      <view class="method-title">第{{methodLevel}}式 · {{methodDetail.levelName}}</view>
      <view class="method-text">{{methodDetail.method}}</view>
      <view class="method-targets">升级标准：{{methodDetail.targets.upgrade || "-"}}</view>
    </view>
    <view class="method-empty" wx:else>
      暂无该动作的训练方法，请稍后刷新。
    </view>
  </view>

  <view class="card">
    <view class="section-title">计划管理</view>
    <view class="hint">若需要从头开始，可重置当前计划并重新创建。</view>
    <button class="ghost-button" bindtap="onResetPlan">重置当前计划</button>
  </view>
</view>


