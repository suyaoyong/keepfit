# 工作记录（2026-02-15）

## 概述
- 今日主要完成三类工作：
  - 功能修复与策略调整（登录/AI触发、云端集合异常、计划限制放宽）。
  - 三页核心 UI 重构与统一（今日训练 / 进度 / 我的），并继续扩展到计划设置、训练历史。
  - 体验细节打磨（补录流程、文案统一、联系作者入口）。
- 风格方向统一为：黑+橙、高对比、徽章信任、强信息层级、证据链表达。

## 需求与决策记录
- 明确“AI 总结”原则：登录后可用，资料按需收集，减少平时摩擦。
- 取消“创建计划时训练资料完整性强校验”，仅在 AI 总结触发时按需校验资料。
- “训练目标”从资料收集项中移除（固定为体能提升）。
- “今日训练”中的“临时加练”更名为“补录历史训练”，并支持历史日期补录（最多往前 7 天）。
- 补录区交互改为折叠式：默认仅按钮，点击后展开，按钮切换为“提交”。
- 计划设置简化：去除意义不大的表单项与推荐流程，保留周/月/日历排期。
- “我的”页术语修正为“个人训练基础资料”，并新增“联系作者”。

## 功能实现与修改

### 1) 今日训练页（pages/workout-today）
- 完成“身份驱动”头部：阶段徽章、连续训练天数、本周完成度、主 CTA。
- 保留“今日训练录入”主流程，优化信息层级和按钮权重。
- “补录历史训练”能力完善：
  - 支持选择历史日期（近 7 天）。
  - 支持补录动作组次及其他训练。
  - 默认收起，按需展开，避免误导与干扰当日录入。
- 位置调整：将“补录历史训练”移动到“智能录入（AI 解析）”下方。
- 智能录入文本区尺寸压缩（纵向更紧凑），降低界面负担。

### 2) 进度页（pages/progress）
- 新增顶部“证据链”模块：
  - 阶段 + Lv 标识。
  - 本周完成天数/计划天数。
  - 完成率进度条。
  - 本月训练天数与记录条数汇总。
- 保留并兼容原有月历、日详情、最近记录与 AI 总结模块。
- 交互同步：切换日期时，顶部证据链指标同步刷新。

### 3) 我的页（pages/mine）
- 重构为“身份档案页”：
  - 顶部身份卡（Lv、阶段、头像昵称、账号状态）。
  - 计划快照、训练基础资料、训练入口、数据与设置分区。
- 新增阶段映射（stage -> Lv），随计划快照自动更新身份标签。
- 新增“联系作者”入口：
  - 弹窗展示微信号、公众号名称。
  - 支持一键复制微信号/公众号。
  - 预留并接入二维码显示位（路径 `/images/author-wechat-qrcode.png`，待补图文件）。
  - 支持点击预览二维码与长按保存。

### 4) 计划设置页（pages/plan-setup）
- 统一为黑橙视觉体系，新增顶部卖点 Hero。
- 顶部文案压缩为强卖点：
  - “先定等级与排期，一键保存云端”。
  - “先定等级，再定排期”。
  - “周/月/日历统一配置，创建后立即生效”。
- 不改业务逻辑，仅做表达与视觉统一。

### 5) 训练历史页（pages/workout-history）
- 改为与全局一致的结构：Header + Hero + 深色记录卡片。
- 强化“按天汇总复盘”表达，保留加载态/错误态/空态。
- 逻辑未改，聚焦 UI 与信息层级统一。

## 云端与稳定性修复
- 修复进度相关云函数中集合名问题：`profiles` -> `profile`，解决线上报错：
  - `database collection not exists: profiles`
- 取消创建计划过程中的训练基础资料硬校验，降低用户摩擦。
- 强化“AI 登录后继续原操作”链路（授权后可继续完成总结触发）。

## 文档与规范更新
- 处理并整理 `spec.md` 乱码段，保留原信息语义。
- 更新品牌与 UI 设计参考文档：`docs/brand_ui.md`（黑橙、高对比、徽章信任、证据链、信息层级）。
- 提交过一次页面重构相关 commit：
  - `db7bbce feat(ui): redesign mine page and unify rhythm across today/progress/mine`

## 验收与调试记录
- 多次执行前端页面 JS 语法检查（`node --check`）通过。
- 已按用户反馈修复补录体验问题：
  - 补录入口位置与展开方式。
  - 历史日期录入可用性。
- 当前“联系作者二维码”功能已接入显示逻辑，但图片文件需落地到：
  - `miniprogram/images/author-wechat-qrcode.png`

## 未完成 / 待后续
- “问题反馈可接收”功能暂未实施（用户确认以后再做）。
- 自动推送链路（企业微信/订阅消息）未接入。
- 若要实现“你能收到用户输入问题”，需新增：
  - 反馈表单 + 云函数 + feedback 集合 + 推送通道（企业微信 webhook）。

## 备注
- 仓库中存在较多历史改动与未跟踪文件，提交时按范围选择，避免误提交无关内容。
- Windows 环境下有 CRLF/LF 提示，属于行尾规范提示，不影响功能。
## 晚间补充（EPUB 阅读与反馈闭环）

### 1) 问题反馈（mine + cloudfunctions/feedback）
- “联系作者”入口调整为“问题反馈”，在“我的 -> 数据与设置”中提供统一入口。
- 反馈弹窗支持：
  - 必填：问题描述（最少 10 字）
  - 选填：联系方式
  - 辅助：作者微信号复制
- 前端提交路径：`callCloud("feedback", { action: "submit", ... })`。
- 云函数 `feedback` 当前策略：
  - 仅写入 `feedback` 集合；
  - 关闭企业微信推送（因云函数出口 IP 不固定 + 企业微信可信 IP 限制）；
  - 返回 `pushed: false`，保持最小可用链路。
- 线上异常排查与修复：
  - 报错 `database collection not exists: feedback`；
  - 通过创建集合后恢复正常写入。

### 2) EPUB 最小可用阅读功能落地（library/book-detail/reader）
- 新增云函数：`cloudfunctions/library`。
- 新增页面：
  - `pages/library`（书库列表）
  - `pages/book-detail`（目录页）
  - `pages/reader`（章节阅读）
- 新增数据库集合（用户已创建）：
  - `books`
  - `book_chapters`
  - `book_progress`
- 云函数动作：
  - `listBooks`
  - `getBookDetail`
  - `getChapter`
  - `getProgress`
  - `saveProgress`
  - `seedQiutu`
- “我的”页面加入阅读入口并最终定稿：
  - 文案：`开始阅读《囚徒健身》`
  - 行为：直达 `book-detail`（不再经过书库页）

### 3) 导入链路与封面处理
- 控制台 JSONL 导入连续失败（格式校验与编码问题），改为“seed 文件 + 云函数导入”方案。
- 预处理脚本：`tools/epub_to_cloud_json.py`
  - 解析 EPUB 章节，生成 `books.json` / `book_chapters.json`
  - 自动提取封面
  - 复制封面到 `cloudfunctions/library/seed/qiutu-cover.jpg`
- `seedQiutu` 增强：
  - 自动上传 `seed/qiutu-cover.jpg` 到云存储
  - 将返回 fileID 回写到 `books.coverUrl`
  - 返回值包含 `coverUploaded` 与 `coverUrl` 供验收

### 4) 编码与稳定性修复（关键）
- 修复了多处由 Windows 控制台编码导致的文本/字符串损坏问题：
  - `pages/mine/index.js` 曾出现字符串断裂导致编译错误；
  - `supportEntries` 文案曾退化为 `?`。
- 处理方式：
  - 以可编译结构重建 `mine/index.js`；
  - 对高风险中文文案使用 unicode 转义写入，避免终端编码污染；
  - 清理 BOM，规避再次触发编译异常。

### 5) 关键验收结果
- `seedQiutu` 执行成功，返回 `coverUploaded: true`，`coverUrl` 为云存储 fileID。
- 阅读页可正常加载书籍内容并保存阅读进度。
- “我的 -> 数据与设置”5 行文案恢复正常（不再显示问号）。

### 6) 仍需注意
- 企业微信自动推送已按决策关闭；当前反馈仅云端可查。
- 若后续恢复消息推送，建议改为固定出口 IP（CVM 中转）或更换不依赖固定 IP 的推送通道。
- `tools/` 和 `data/` 中存在导入中间产物，提交时应按需选择，避免仓库噪音。
## 晚间补充（二）：EPUB 插图可视化增强（已验收）

### 1) 目标
- 解决“章节图片不显示/不适配手机”的体验问题。
- 在不增加用户操作负担的前提下实现：
  - 图片自适应手机宽度
  - 点击图片进入微信原生预览（可缩放、横向查看）

### 2) 根因定位
- `seedQiutu` 后章节中的图片地址为 `cloud://...`。
- `rich-text` 不能直接稳定渲染 `cloud://`，导致正文插图缺失。

### 3) 技术实现
#### 3.1 预处理与入库
- `tools/epub_to_cloud_json.py` 增强为：
  - 解析章节内 `<img>`
  - 提取图片资产到 `cloudfunctions/library/seed/assets/qiutujianshen/`
  - 在章节 HTML 中写入 `seedasset://<filename>` 占位引用
- `cloudfunctions/library/index.js` 的 `seedQiutu` 增强为：
  - 自动上传 `seed/assets/<bookId>/` 下图片到云存储
  - 将 `seedasset://...` 替换为云文件 `fileID`
  - 写回 `book_chapters.contentHtml`

#### 3.2 阅读页渲染
- `pages/reader/index.js`：
  - 加入 `cloud://` -> 临时 HTTPS URL 的自动转换（`wx.cloud.getTempFileURL`）
  - 章节解析为“文本块 + 图片块”
  - 汇总可预览图片 URL 列表
- `pages/reader/index.wxml`：
  - 图片块改为原生 `<image>`，绑定 `bindtap="onPreviewImage"`
- `pages/reader/index.wxss`：
  - 图片样式：`width: 100%` + `height: auto`，并保留圆角与暗色背景一致性

### 4) 验收结论
- 用户实测确认：
  - 章节图片可见
  - 图片可点击放大预览
- 当前状态满足“1 + 2”（自适应 + 点击预览）目标，后续可选再做页面级横屏模式。
